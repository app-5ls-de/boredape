<!DOCTYPE html>
<html>
  <head>
    <title>Bored Ape</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      img#ape {
        position: fixed;
        left: 50%;
        bottom: 0;
        transform: translateX(-50%);
        margin: 0 auto;
        max-width: 100vw;
      }
    </style>
  </head>

  <body>
    <img id="ape" src="" />

    <img id="preload" style="display: none" />

    <script>
      let base =
        "https://cdn.jsdelivr.net/gh/PatrickHaussmann/boredape@v1.0.0/data/";
      let img = document.getElementById("ape");
      let img_preload = document.getElementById("preload");
      let max = 10000;

      const rand = () => Math.floor(Math.random() * max);

      async function get_color(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error(response.status);
        const data = await response.json();
        return data.color;
      }

      const load_img = (img_el, src) =>
        new Promise((resolve, reject) => {
          img_el.onload = resolve;
          img_el.onerror = reject;
          img_el.src = src;
        });

      function ape(n, preload = false) {
        let url_json = base + n + ".json";
        let url_img = base + n + ".png";

        if (preload) {
          return Promise.all([
            get_color(url_json),
            load_img(img_preload, url_img),
          ]).then(([color]) => {
            document.body.style.backgroundColor = color;
            load_img(img, url_img);
          });
        }

        get_color(url_json).then((color) => {
          document.body.style.backgroundColor = color;
        });
        load_img(img, url_img);
      }

      const timeout = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

      async function timer() {
        await ape(rand(), true);
        await timeout(2000);
        timer();
      }

      let number = rand();
      let option = location.search ? location.search : location.hash;
      if (option) {
        if (option.substring(1) == "play") number = null;

        let num = Number(option.substring(1));
        if (Number.isInteger(num) && num < max) number = num;
      }

      if (number) ape(number);
      else timer();
    </script>
  </body>
</html>
